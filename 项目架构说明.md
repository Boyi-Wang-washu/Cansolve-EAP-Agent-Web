# 🎓 Cansolve EAP 英语教学助手 - 项目架构说明

## 📋 项目概述

**项目名称**：Cansolve EAP Agent Web（BNBU 英语教学助手）  
**当前版本**：MVP (Minimum Viable Product)  
**在线地址**：https://cansolve-eap-agent-web.vercel.app  
**GitHub**：https://github.com/Boyi-Wang-washu/Cansolve-EAP-Agent-Web

---

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────┐
│                    用户浏览器                        │
│        (学生端 / 教师端 / 管理员端)                   │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ HTTPS
                   ↓
┌─────────────────────────────────────────────────────┐
│                前端 (Next.js 14)                     │
│              部署在: Vercel (免费)                   │
│       https://cansolve-eap-agent-web.vercel.app    │
│                                                      │
│  功能:                                              │
│  ✅ 用户认证 (登录/登出)                             │
│  ✅ 仪表盘 (Dashboard)                               │
│  ✅ 1v1 聊天辅导 (集成 Flask API)                    │
│  ✅ 测验系统                                         │
│  ✅ 学习报告                                         │
│  ✅ 材料管理 (教师端)                               │
│  ✅ 材料上传                                         │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ REST API 调用
                   ↓
┌─────────────────────────────────────────────────────┐
│              后端 API (两个服务)                     │
│                                                      │
│  1. FastAPI (Python)                               │
│     位置: backend/                                 │
│     用途: 用户认证、会话管理、材料管理                │
│     状态: 🔲 占位实现（待开发）                     │
│                                                      │
│  2. Flask Chat API (Python)                        │
│     位置: memorized/ (独立项目)                      │
│     部署: Render - https://eap-1v1-ai-tutor.onrender.com │
│     用途: AI 对话、聊天历史                         │
│     状态: ✅ 运行中                                 │
└──────────────────┬──────────────────────────────────┘
                   │
                   │ 未来接入
                   ↓
┌─────────────────────────────────────────────────────┐
│              AI 服务 (待接入)                         │
│     - OpenAI API                                   │
│     - 扣子 (Coze)                                   │
│     - 智谱 AI                                      │
└─────────────────────────────────────────────────────┘
```

---

## 📁 项目文件结构

```
全栈开发V2/
├── src/                              # 前端源码
│   ├── app/                          # Next.js App Router
│   │   ├── auth/login/              # ✅ 登录页面
│   │   ├── dashboard/                # ✅ 仪表盘
│   │   ├── tutor/                    # 学生端
│   │   │   ├── chat/                # ✅ 1v1 聊天 (使用 ChatInterface)
│   │   │   └── select-material/     # ✅ 材料选择
│   │   ├── quiz/                     # ✅ 测验页面
│   │   ├── reports/                  # ✅ 学习报告
│   │   └── teacher/                  # 教师端
│   │       └── materials/           # ✅ 材料管理+上传
│   ├── components/                   # React 组件
│   │   ├── chat/                     # 🆕 聊天组件
│   │   │   ├── ChatMessage.tsx      # 单条消息
│   │   │   ├── ChatInput.tsx        # 输入框
│   │   │   └── ChatInterface.tsx    # 主界面
│   │   └── layout/                   # 布局组件
│   │       ├── DashboardLayout.tsx  # 统一布局
│   │       ├── Header.tsx            # 顶部导航
│   │       └── Sidebar.tsx           # 侧边菜单
│   ├── lib/                          # 工具库
│   │   ├── api.ts                   # FastAPI 客户端
│   │   └── chatApi.ts               # 🆕 Flask Chat API 客户端
│   ├── store/                        # 状态管理 (Zustand)
│   │   └── authStore.ts             # 认证状态 (+ isLoading)
│   └── types/                        # TypeScript 类型
│       ├── types.ts                 # 通用类型
│       └── chat.ts                  # 🆕 聊天类型
│
├── backend/                          # 后端 (FastAPI)
│   ├── app/
│   │   ├── main.py                  # FastAPI 应用入口
│   │   ├── api/v1/endpoints/       # API 端点
│   │   │   ├── auth.py             # 认证
│   │   │   ├── sessions.py         # 会话管理
│   │   │   ├── ai.py               # AI 功能
│   │   │   └── materials.py        # 材料管理
│   │   ├── core/                    # 核心配置
│   │   │   ├── config.py           # 环境配置
│   │   │   └── security.py         # JWT 工具
│   │   └── db/                      # 数据库
│   │       ├── database.py         # 数据库连接
│   │       └── models.py           # 数据模型
│   ├── requirements.txt             # Python 依赖
│   └── run.py                       # 启动脚本
│
├── ui_pages_496770912770/           # UI 设计原型
├── package.json                      # 前端依赖
└── README.md                         # 项目说明
```

---

## 🔑 关键技术组件

### 前端架构

#### 1. **状态管理 (Zustand)**
**文件**：`src/store/authStore.ts`

**状态**：
```typescript
{
  user: User | null,        // 当前用户
  token: string | null,     // JWT token
  isAuthenticated: boolean,  // 是否已登录
  isLoading: boolean,        // 是否正在加载认证状态
}
```

**方法**：
- `setAuth(user, token)` - 设置登录状态
- `logout()` - 登出
- `initAuth()` - 从 localStorage 恢复状态

#### 2. **API 客户端**
**文件**：
- `src/lib/api.ts` - FastAPI 通信（后端服务器）
- `src/lib/chatApi.ts` - Flask Chat API 通信（AI 服务）

**环境变量**：
- `NEXT_PUBLIC_API_URL` - FastAPI 地址（暂未使用）
- `NEXT_PUBLIC_CHAT_API_URL` - Flask Chat API 地址

#### 3. **聊天组件集成**
**组件树**：
```
page.tsx (路由)
  └─ DashboardLayout (布局)
      └─ ChatInterface (主聊天界面)
          ├─ ChatMessage (显示消息)
          └─ ChatInput (输入框)
```

**数据流**：
```
用户输入消息
  └─ ChatInterface.handleSend()
      └─ chatApi.sendChatMessage()
          └─ 调用 Flask API (https://eap-1v1-ai-tutor.onrender.com/api/chat)
              └─ 返回 AI 回复
                  └─ 更新 messages 状态
```

---

### 后端架构

#### 1. **FastAPI 后端**（占位）
**位置**：`backend/`  
**状态**：API 框架已搭建，逻辑待实现

**端点**：
- `/api/v1/auth/login` - 登录（模拟数据）
- `/api/v1/auth/me` - 获取当前用户
- `/api/v1/sessions` - 会话管理（占位）
- `/api/v1/materials` - 材料管理（占位）

#### 2. **Flask Chat API**（运行中）
**部署**：Render  
**地址**：https://eap-1v1-ai-tutor.onrender.com  
**状态**：✅ 运行中

**端点**：
- `GET /api/health` - 健康检查
- `POST /api/chat` - 发送消息（需要 X-User-ID header）
- `GET /api/history` - 获取历史
- `POST /api/clear` - 清除历史

---

## 🔐 认证流程

### 当前实现（模拟认证）

```
1. 用户在登录页输入 student001 / student123
   ↓
2. 前端验证（mockUsers 字典）
   ↓
3. 调用 setAuth(user, token)
   ↓
4. 保存到 localStorage
   - user: JSON.stringify(user)
   - token: token
   ↓
5. 跳转到 /dashboard
   ↓
6. Dashboard 读取 user 显示
   ↓
7. 点击 1v1 Tutoring
   ↓
8. ChatPage 加载时：
   - providers.tsx 调用 initAuth()
   - 从 localStorage 读取 user 和 token
   - 设置到 authStore
   - isLoading 变为 false
   ↓
9. 检查 user 是否存在
   - 有：显示聊天界面 ✅
   - 无：跳回登录 ❌
```

### 关键修复

**问题**：页面加载时 user 还是 null，触发了跳转  
**解决**：添加 isLoading 状态，等待 initAuth 完成后再检查

---

## 🎯 核心功能说明

### ✅ 已实现的功能

#### 1. 用户认证
- **登录页面**：模拟账号登录
- **状态持久化**：localStorage 保存
- **自动恢复**：页面刷新后自动恢复登录状态
- **路由保护**：未登录用户跳转登录页

#### 2. 1v1 聊天辅导
- **集成 Flask API**：调用 Render 上的 Flask 服务
- **实时对话**：发送消息，接收 AI 回复
- **历史记录**：显示用户和 AI 的对话历史
- **Token 统计**：显示每次 AI 回复的 Token 使用量
- **清除历史**：一键清除对话记录

#### 3. UI/UX
- **响应式设计**：TailwindCSS
- **统一配色**：青绿色主题
- **加载状态**：显示 Loading 动画
- **错误处理**：友好的错误提示

### 🔲 待实现的功能

#### 1. FastAPI 后端逻辑
- ❌ 真实的数据库操作
- ❌ 文件上传和处理
- ❌ 会话数据持久化

#### 2. AI 功能
- 🔲 智能题目生成
- 🔲 学习报告分析
- 🔲 语法纠错

#### 3. 认证系统
- 🔲 对接学校 iSpace
- 🔲 密码加密
- 🔲 权限管理

---

## 🌐 部署架构

### 前端 (Vercel)
```
GitHub 仓库
  ↓ (Push)
Vercel 自动检测
  ↓
构建 Next.js (npm run build)
  ↓
部署到全球 CDN
  ↓
用户访问：https://cansolve-eap-agent-web.vercel.app
```

### 后端 (Render)
```
GitHub 仓库（Flask 项目）
  ↓ (Push)
Render 自动检测
  ↓
构建 Python 应用
  ↓
运行 gunicorn app:app
  ↓
用户调用：https://eap-1v1-ai-tutor.onrender.com/api/chat
```

---

## 🛠️ 开发环境

### 本地开发
- **前端**：`npm run dev` → http://localhost:3000
- **后端 FastAPI**：`python backend/run.py` → http://localhost:8000
- **后端 Flask**：`python memorized/app.py` → http://localhost:5000

### 生产环境
- **前端**：Vercel 托管
- **Flask Chat**：Render 托管
- **FastAPI**：待部署

---

## 🔧 关键配置

### 环境变量 (Vercel)
```env
NEXT_PUBLIC_CHAT_API_URL=https://eap-1v1-ai-tutor.onrender.com
```

### 环境变量 (Render - Flask)
```env
PORT=5000
# 其他 Flask 需要的环境变量
```

---

## 📊 数据库设计（未实现）

### 数据表
1. **users** - 用户表
2. **materials** - 材料表
3. **sessions** - 会话表
4. **messages** - 消息表
5. **learning_reports** - 学习报告表
6. **material_texts** - 材料文本表

**状态**：表结构已定义，CRUD 操作待实现

---

## 🎨 设计系统

### 颜色主题
- **Primary**：`#1B8C79`（青绿色）
- **Secondary**：`#37436A`（深蓝色）
- **Accent**：`#080D1E`（深灰色）
- **Success**：`#10B981`（绿色）
- **Error**：`#EF4444`（红色）

### 响应式断点
- 移动端：< 768px
- 平板：768px - 1024px
- 桌面：> 1024px

---

## 📈 开发进度

### ✅ 已完成 (100%)
- [x] 所有 UI 页面（9个）
- [x] 响应式布局
- [x] 用户认证流程
- [x] 1v1 聊天集成（Flask API）
- [x] 导航和路由
- [x] 状态管理（Zustand）
- [x] 自动部署流程

### 🔲 进行中
- [ ] 修复认证竞态问题（当前进度）
- [ ] Flask API 在生产环境测试

### 📋 待开始
- [ ] FastAPI 真实数据库操作
- [ ] AI 功能接入
- [ ] 学校认证对接
- [ ] 文件上传处理

---

## 🔑 测试账号

| 角色 | 用户名 | 密码 |
|------|--------|------|
| 学生 | student001 | student123 |
| 教师 | teacher001 | teacher123 |
| 管理员 | admin | admin123 |

---

## 📝 最近的主要修改

### 1. 集成 1v1 聊天功能
- 创建聊天相关组件
- 集成 Flask Chat API
- 配置环境变量

### 2. 修复认证问题
- 添加 isLoading 状态
- 修复竞态条件
- 添加调试日志

### 3. 导航优化
- 修复侧边栏链接
- 修复 Dashboard 快速入口
- 确保正确的路由跳转

---

## 🎯 下一步计划

### 短期 (1-2周)
1. ✅ 测试和稳定当前功能
2. 🔲 修复所有已知 bug
3. 🔲 完善 UI/UX 细节

### 中期 (2-4周)
1. 🔲 接入真实 AI API
2. 🔲 实现 FastAPI 数据库操作
3. 🔲 对接学校认证系统

### 长期 (1-2月)
1. 🔲 完整的数据库功能
2. 🔲 文件上传和处理
3. 🔲 性能优化
4. 🔲 生产环境部署

---

## 📞 技术栈总结

### 前端
- **框架**：Next.js 14 (App Router)
- **语言**：TypeScript
- **样式**：TailwindCSS
- **状态**：Zustand
- **HTTP**：Axios
- **图标**：Font Awesome

### 后端
- **Chat API**：Flask (Python)
- **Main API**：FastAPI (Python - 待开发)
- **数据库**：PostgreSQL（结构已定义）
- **ORM**：SQLAlchemy

### 部署
- **前端**：Vercel (免费)
- **Flask**：Render (免费)
- **FastAPI**：待部署
- **数据库**：待配置

---

**此文档保持更新，请根据实际开发进度定期更新！** 📝

